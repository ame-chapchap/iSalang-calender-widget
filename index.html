<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Googleカレンダーウィジェット</title>
<style>
  :root {
    --bg-grad-a:#e8f4f8;
    --bg-grad-b:#f0f8e8;
    --ink:#37352f;
    --ink-sub:#495057;
    --muted:#6b6866;
    --chip:#42a5f5;
  }
  *{box-sizing:border-box; margin:0; padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif; background:#f8f9fa; color:var(--ink); line-height:1.5}

  .calendar-container{
    width:100%; max-width:none; min-height:100vh;
    padding:20px; background:linear-gradient(135deg,var(--bg-grad-a),var(--bg-grad-b));
    border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,.1)
  }
  .calendar-header{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; margin-bottom:16px; flex-wrap:wrap;
  }
  .calendar-nav{display:flex; align-items:center; gap:8px}
  .nav-btn{
    background:rgba(255,255,255,.9); border:0; border-radius:8px; padding:8px 12px;
    font-weight:600; cursor:pointer; transition:.2s; backdrop-filter:blur(10px)
  }
  .nav-btn:hover{transform:translateY(-1px)}
  .current-month{font-size:18px; font-weight:700}

  .view-toggle{display:flex; gap:4px; background:rgba(255,255,255,.8); padding:4px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08)}
  .view-btn{border:0; background:transparent; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:14px; color:#6b6866; font-weight:500}
  .view-btn.active{background:linear-gradient(135deg,#a8e6cf,#88d8a3); color:#2d5016; font-weight:700; box-shadow:0 2px 6px rgba(0,0,0,.12)}

  .calendar-frame{
    width:100%; background:rgba(255,255,255,.95); border:1px solid rgba(255,255,255,.6);
    border-radius:16px; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.1)
  }

  .calendar-header-row{
    display:grid; grid-template-columns:repeat(7,1fr); background:#fff
  }
  .day-header{
    padding:12px 4px; text-align:center; font-weight:700; font-size:14px; color:var(--ink-sub); background:#f8f9fa
  }

  .calendar-grid{
    display:grid; grid-template-columns:repeat(7,1fr); background:#fff;
  }
  .calendar-cell{
    min-height:90px; padding:6px 6px 6px 6px; border-top:1px solid #f1f3f5; border-left:1px solid #f1f3f5;
    display:flex; flex-direction:column; gap:4px; overflow:hidden;
  }
  .calendar-cell:nth-child(7n+1){border-left:0} /* 左端 */
  .date-number{font-weight:700; font-size:12px; color:var(--ink-sub)}
  .other-month .date-number{color:#adb5bd}
  .today{background:#e3f2fd}
  .today .date-number{
    background:#2196f3; color:#fff; border-radius:999px; display:inline-flex;
    align-items:center; justify-content:center; width:22px; height:22px; font-size:12px
  }

  .events-container{display:flex; flex-direction:column; gap:2px; overflow:hidden}

  /* イベントは1行表示＋省略＆クリック可能 */
  .event{
    background:rgba(66,165,245,.75); color:#fff; border-radius:4px;
    padding:2px 6px; display:flex; align-items:center; gap:6px;
    overflow:hidden; cursor:pointer; user-select:none; transition:opacity .15s ease;
  }
  .event:hover{opacity:.85}
  .event-time{font-weight:700; font-size:10px; white-space:nowrap; flex:0 0 auto}
  .event-title{font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1 1 auto}

  .loading,.error{display:flex; align-items:center; justify-content:center; height:320px; color:var(--muted); font-size:16px}
  .error{flex-direction:column; gap:8px; color:#dc3545}

  /* Mobile */
  @media (max-width:768px){
    .calendar-container{padding:14px}
    .view-btn{padding:4px 10px; font-size:13px}
    .day-header{font-size:12px; padding:8px 2px}
    .calendar-cell{min-height:70px; padding:4px}
    .event-title{font-size:10px}
  }
</style>
</head>
<body>
  <div class="calendar-container">
    <div class="calendar-header">
      <div class="calendar-nav">
        <button class="nav-btn" id="prevBtn">‹</button>
        <div class="current-month" id="current-month">--</div>
        <button class="nav-btn" id="nextBtn">›</button>
        <button class="nav-btn" id="todayBtn">今日</button>
      </div>
      <div class="view-toggle">
        <button class="view-btn active" data-view="month">月</button>
        <button class="view-btn" data-view="week">週</button>
        <button class="view-btn" data-view="agenda">予定</button>
      </div>
    </div>

    <div class="calendar-frame">
      <div class="calendar-header-row" id="weekday-row">
        <div class="day-header">月</div><div class="day-header">火</div><div class="day-header">水</div>
        <div class="day-header">木</div><div class="day-header">金</div><div class="day-header">土</div><div class="day-header">日</div>
      </div>
      <div id="calendar-grid" class="calendar-grid"></div>
      <div id="loading" class="loading" style="display:none">📅 読み込み中…</div>
      <div id="error" class="error" style="display:none"></div>
    </div>
  </div>

<script>
  // ======== 設定 ========
  let apiKey   = 'YOUR_API_KEY_HERE';          // ←差し替え
  const calendarId = 'isalang.2ain@gmail.com'; // 公開カレンダー or OAuthが必要
  // ======================

  let currentView = 'month';
  let currentDate = new Date();
  let events = [];

  // --- Utils ---
  const $ = sel => document.querySelector(sel);
  function fmtMonth(d){
    const m = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
    return `${d.getFullYear()}年${m[d.getMonth()]}`;
  }
  function sameDay(a,b){return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate()}

  // Googleの終日は end.date が翌日（排他的）
  function parseEventRange(ev){
    let start = ev.start?.dateTime ? new Date(ev.start.dateTime) : new Date(ev.start.date + 'T00:00:00');
    let end   = ev.end?.dateTime   ? new Date(ev.end.dateTime)   : new Date(ev.end.date   + 'T00:00:00');
    if (ev.start?.date && ev.end?.date) { // 終日
      end.setDate(end.getDate() - 1); // 包括に変換
      end.setHours(23,59,59,999);
    }
    // 端数吸収
    start.setMilliseconds(0);
    return {start, end};
  }
  function eventOccursOn(date, ev){
    const {start, end} = parseEventRange(ev);
    const d0 = new Date(date); d0.setHours(0,0,0,0);
    const d1 = new Date(date); d1.setHours(23,59,59,999);
    return (start <= d1 && end >= d0);
  }

  // --- Data fetch ---
  async function loadCalendar(){
    if (!apiKey) return;
    $('#loading').style.display='flex';
    $('#error').style.display='none';

    try{
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);

      // 月曜始まりへ拡張
      const calStart = new Date(first);
      calStart.setDate(first.getDate() - ((first.getDay()+6)%7));
      const calEnd = new Date(last);
      calEnd.setDate(last.getDate() + ((7 - last.getDay())%7));

      const url = new URL(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`);
      url.searchParams.set('key', apiKey);
      url.searchParams.set('timeMin', calStart.toISOString());
      url.searchParams.set('timeMax', calEnd.toISOString());
      url.searchParams.set('singleEvents', 'true');
      url.searchParams.set('orderBy', 'startTime');

      const res = await fetch(url);
      if (!res.ok) throw new Error(`API ${res.status}`);
      const data = await res.json();
      events = Array.isArray(data.items) ? data.items : [];

      $('#loading').style.display='none';
      render();
    }catch(e){
      $('#loading').style.display='none';
      const box = $('#error');
      box.style.display='flex';
      box.innerHTML = `<div>⚠️ 読み込み失敗</div><div style="font-size:14px;color:#6b6866">${e.message.includes('403')?'公開設定または認可が必要です（403）。':'APIキー/ID を確認してください。'}</div>`;
      console.error(e);
    }
  }

  // --- Renderers ---
  function render(){
    $('#current-month').textContent = fmtMonth(currentDate);
    if (currentView==='month'){ renderMonth(); }
    else if (currentView==='week'){ renderWeek(); }
    else { renderAgenda(); }
  }

  function renderMonth(){
    const grid = $('#calendar-grid');
    grid.className = 'calendar-grid';
    grid.style.display='grid';
    grid.style.gridTemplateColumns='repeat(7,1fr)';
    grid.innerHTML='';

    const y = currentDate.getFullYear();
    const m = currentDate.getMonth();
    const first = new Date(y, m, 1);
    const start = new Date(first);
    start.setDate(first.getDate() - ((first.getDay()+6)%7));

    const today = new Date();

    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);

      const cell = document.createElement('div');
      cell.className = 'calendar-cell' + (d.getMonth()!==m?' other-month':'') + (sameDay(d,today)?' today':'');

      const dn = document.createElement('div');
      dn.className='date-number'; dn.textContent = d.getDate();
      cell.appendChild(dn);

      const wrap = document.createElement('div');
      wrap.className='events-container';
      cell.appendChild(wrap);

      const list = events.filter(ev => eventOccursOn(d, ev)).slice(0, 3);
      list.forEach(ev => wrap.appendChild(makeEventChip(ev)));

      grid.appendChild(cell);
    }
  }

  function renderWeek(){
    const grid = $('#calendar-grid');
    grid.style.display='block';
    grid.style.gridTemplateColumns='none';
    grid.innerHTML='';

    const base = new Date(currentDate);
    const dow = (base.getDay()+6)%7; // 月=0
    const weekStart = new Date(base); weekStart.setDate(base.getDate()-dow);

    const box = document.createElement('div'); box.style.padding='20px';

    for(let i=0;i<7;i++){
      const d = new Date(weekStart); d.setDate(weekStart.getDate()+i);
      const day = document.createElement('div');
      day.style.cssText = 'margin-bottom:16px;background:rgba(255,255,255,.95);border-radius:8px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)';

      const head = document.createElement('div');
      head.style.cssText = 'font-weight:700;font-size:16px;margin-bottom:8px;color:#495057;border-bottom:1px solid #e9ecef;padding-bottom:8px';
      head.textContent = `${d.getMonth()+1}/${d.getDate()} (${['日','月','火','水','木','金','土'][d.getDay()]})`;
      day.appendChild(head);

      const list = events.filter(ev => eventOccursOn(d, ev));
      if (list.length===0){
        const none = document.createElement('div');
        none.style.cssText='color:#adb5bd;font-style:italic'; none.textContent='予定なし';
        day.appendChild(none);
      }else{
        list.forEach(ev=>{
          const item = document.createElement('div');
          item.style.cssText='padding:8px;margin:4px 0;background:rgba(66,165,245,.08);border-left:3px solid rgba(66,165,245,.7);border-radius:4px';
          const start = ev.start?.dateTime ? new Date(ev.start.dateTime) : null;
          const t = start ? start.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '';
          const title = (ev.summary||'予定').split('\n')[0];

          item.innerHTML = `${t?`<div style="font-size:14px;font-weight:700;color:rgba(66,165,245,.9)">${t}</div>`:''}
                            <div style="font-size:14px;color:#37352f;margin-top:2px">${title}</div>`;
          item.style.cursor='pointer';
          const link = ev.htmlLink;
          if (link) item.onclick = ()=>window.open(link,'_blank','noopener');
          day.appendChild(item);
        });
      }
      box.appendChild(day);
    }
    grid.appendChild(box);
  }

  function renderAgenda(){
    const grid = $('#calendar-grid');
    grid.style.display='block';
    grid.style.gridTemplateColumns='none';
    grid.innerHTML='';

    const m = currentDate.getMonth(), y = currentDate.getFullYear();
    const list = events.filter(ev=>{
      const s = ev.start?.dateTime ? new Date(ev.start.dateTime) : new Date(ev.start.date+'T00:00:00');
      return s.getMonth()===m && s.getFullYear()===y;
    }).sort((a,b)=>{
      const A = new Date(a.start.dateTime || a.start.date);
      const B = new Date(b.start.dateTime || b.start.date);
      return A-B;
    });

    if (list.length===0){
      const none = document.createElement('div');
      none.style.cssText='padding:40px 20px;text-align:center;color:#6b6866';
      none.textContent='この月には予定がありません';
      grid.appendChild(none);
      return;
    }

    const box = document.createElement('div'); box.style.padding='20px';
    list.forEach(ev=>{
      const eventDate = new Date(ev.start.dateTime || ev.start.date);
      const wrap = document.createElement('div');
      wrap.style.cssText='display:flex;align-items:center;padding:12px;margin-bottom:8px;background:rgba(255,255,255,.95);border-radius:8px;border-left:4px solid rgba(66,165,245,.7);box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:pointer';

      const dateEl = document.createElement('div');
      dateEl.style.cssText='min-width:60px;text-align:center;margin-right:16px;color:#495057';
      dateEl.innerHTML = `<div style="font-size:18px;font-weight:700">${eventDate.getDate()}</div>
                          <div style="font-size:12px">${['日','月','火','水','木','金','土'][eventDate.getDay()]}</div>`;

      const content = document.createElement('div'); content.style.flex='1';
      const t = ev.start?.dateTime ? eventDate.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '';
      const title = (ev.summary||'予定').split('\n')[0];
      content.innerHTML = `${t?`<div style="font-size:14px;font-weight:700;color:rgba(66,165,245,.9);margin-bottom:4px">${t}</div>`:''}
                           <div style="font-size:16px;color:#37352f">${title}</div>`;

      wrap.appendChild(dateEl); wrap.appendChild(content);
      if (ev.htmlLink) wrap.onclick = ()=>window.open(ev.htmlLink,'_blank','noopener');
      grid.appendChild(wrap);
    });
  }

  function makeEventChip(ev){
    const el = document.createElement('div');
    el.className='event'; el.title = ev.summary || '予定';

    let timeStr = '';
    if (ev.start?.dateTime){
      const dt = new Date(ev.start.dateTime);
      timeStr = dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
    }

    if (timeStr){
      const t = document.createElement('div'); t.className='event-time'; t.textContent=timeStr; el.appendChild(t);
    }
    const titleEl = document.createElement('div');
    titleEl.className='event-title';
    titleEl.textContent = (ev.summary||'予定').split('\n')[0];
    el.appendChild(titleEl);

    if (ev.htmlLink){
      el.addEventListener('click', (e)=>{ e.stopPropagation(); window.open(ev.htmlLink,'_blank','noopener'); });
    }
    return el;
  }

  // --- Handlers ---
  function setView(view, btn){
    currentView = view;
    document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    render();
  }

  // init
  window.addEventListener('load', ()=>{
    $('#current-month').textContent = fmtMonth(currentDate);

    // nav buttons
    $('#prevBtn').onclick = ()=>{ 
      if (currentView==='week'){ currentDate.setDate(currentDate.getDate()-7); }
      else { currentDate.setMonth(currentDate.getMonth()-1); }
      loadCalendar();
    };
    $('#nextBtn').onclick = ()=>{
      if (currentView==='week'){ currentDate.setDate(currentDate.getDate()+7); }
      else { currentDate.setMonth(currentDate.getMonth()+1); }
      loadCalendar();
    };
    $('#todayBtn').onclick = ()=>{ currentDate = new Date(); loadCalendar(); };

    // view toggle
    document.querySelectorAll('.view-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> setView(btn.dataset.view, btn));
    });

    loadCalendar();
  });
</script>
</body>
</html>
