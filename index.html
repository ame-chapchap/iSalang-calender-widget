<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Google Calendar Widget</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#d6e9f0 0%,#f0e6d2 100%);
      min-height:100vh;overflow-x:hidden;padding:20px
    }
    .calendar-container{
      max-width:900px;margin:0 auto;background:rgba(255,255,255,.92);
      border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.08);
      overflow:hidden;border:1px solid rgba(255,255,255,.3)
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .calendar-header{
      display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:10px 14px;padding:20px 20px 12px 20px;background:rgba(255,255,255,.86)
    }
    .navs{display:flex;gap:8px;align-items:center}
    .nav-button{
      background:rgba(214,233,240,.6);border:1px solid rgba(214,233,240,.8);
      border-radius:8px;padding:8px 12px;min-height:40px;min-width:40px;
      cursor:pointer;font-size:18px;color:#5a7c89;transition:.2s;display:flex;align-items:center;justify-content:center
    }
    .nav-button:hover{background:rgba(214,233,240,.8);color:#4a6c79}
    .month-year{font-size:22px;font-weight:600;color:#4a6c79;text-align:center;flex:1}
    .view-controls{display:flex;gap:6px;background:rgba(214,233,240,.35);border-radius:10px;padding:4px}
    .view-button{
      background:transparent;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;
      font-size:14px;color:#5a7c89;transition:.2s;font-weight:500;min-height:36px
    }
    .view-button.active{background:#fff;color:#4a6c79;box-shadow:0 2px 8px rgba(0,0,0,.08)}

    /* å…±é€šãƒ“ãƒ¥ãƒ¼æ  */
    .calendar-view{display:none}
    .calendar-view.active{display:block}
    .week-view{display:none;background:rgba(255,255,255,.7)}
    .week-view.active{display:block}
    .agenda-view{display:none;background:rgba(255,255,255,.7);padding:20px}
    .agenda-view.active{display:block}

    /* æœˆãƒ“ãƒ¥ãƒ¼ */
    .calendar-grid{
      display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:rgba(255,255,255,.1);
      border-radius:14px;padding:10px;grid-auto-rows:minmax(120px,auto)
    }
    .calendar-header-cell{
      background:rgba(200,200,200,.3);color:#2c3e50;text-align:center;padding:12px 6px;
      font-weight:700;font-size:12px;border-radius:10px;border:1px solid rgba(200,200,200,.25)
    }
    .calendar-cell{
      background:rgba(255,255,255,.45);border-radius:10px;padding:6px;position:relative;transition:.2s
    }
    .calendar-cell:hover{background:rgba(255,255,255,.62);box-shadow:0 1px 6px rgba(0,0,0,.07)}
    .calendar-cell.today{background:linear-gradient(135deg,rgba(168,230,207,.35) 0%,rgba(136,216,163,.45) 100%);outline:2px solid rgba(136,216,163,.5)}
    .calendar-cell.other-month{background:rgba(200,200,200,.18);color:#6f7f86;opacity:.85}
    .calendar-cell.other-month .date-number{color:#6f7f86;opacity:1}
    .date-number{font-size:14px;font-weight:700;color:#2c3e50;margin-bottom:4px}

    .event{
      background:linear-gradient(135deg,rgba(66,165,245,.45) 0%,rgba(42,132,228,.55) 100%);
      color:#fff;font-size:11px;padding:4px 6px;border-radius:6px;margin-bottom:2px;cursor:pointer;
      border:1px solid rgba(255,255,255,.25);box-shadow:0 2px 8px rgba(66,165,245,.12)
    }
    .event-time{font-weight:700;display:block;font-size:10px;opacity:.95}
    .event-title{font-size:10px;line-height:1.35;word-break:break-word}
    /* éå»ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¦ä»¶1ï¼‰ */
    .event.past{
      background:linear-gradient(135deg,rgba(149,165,166,.35) 0%,rgba(127,140,141,.45) 100%) !important;
      color:rgba(255,255,255,.92) !important;border-color:rgba(255,255,255,.25) !important;
      box-shadow:0 1px 4px rgba(149,165,166,.18) !important;opacity:.95
    }

    /* é€±ãƒ“ãƒ¥ãƒ¼ */
    .week-header{display:grid;grid-template-columns:80px repeat(7,minmax(0,1fr));background:#f5f7f9;border-bottom:1px solid rgba(214,233,240,.6)}
    .week-header .time-column,.week-header .day-header{
      padding:12px 8px;font-weight:600;font-size:13px;color:#5a7c89;text-align:center
    }
    .week-grid{display:grid;grid-template-columns:80px repeat(7,minmax(0,1fr));min-height:600px;position:relative}
    .week-time-column{background:rgba(255,255,255,.55);border-right:1px solid rgba(214,233,240,.5)}
    .week-time-slot{height:60px;padding:8px;border-bottom:1px solid rgba(214,233,240,.35);font-size:12px;color:#5a7c89;display:flex;align-items:flex-start;justify-content:center}

    .week-day-column{background:rgba(255,255,255,.55);position:relative}
    .week-day-column.today{background:rgba(173,216,230,.15)}
    .week-time-slot-day{height:60px;border-bottom:1px solid rgba(214,233,240,.35);padding:4px;position:relative}
    .week-event{
      background:rgba(154,205,223,.25);color:#2a4a5b;padding:4px 8px;border-radius:4px;margin-bottom:2px;cursor:pointer;
      font-size:11px;border-left:3px solid #6b9fc7
    }
    .week-event-time{font-weight:700;font-size:10px}
    .week-event-title{font-weight:600;font-size:10px}
    /* ç¸¦ç·šã®å®‰å®šåŒ–ï¼ˆè¦ä»¶2ï¼‰ */
    .week-day-column::before{
      content:"";position:absolute;left:0;top:0;bottom:0;width:1px;background:rgba(214,233,240,.85)
    }
    .week-grid::after{
      content:"";position:absolute;right:0;top:0;bottom:0;width:1px;background:rgba(214,233,240,.85)
    }

    /* äºˆå®šï¼ˆã‚¢ã‚¸ã‚§ãƒ³ãƒ€ï¼‰ãƒ“ãƒ¥ãƒ¼ */
    .agenda-date{
      font-size:18px;font-weight:700;color:#4a6c79;margin:18px 0 10px;border-bottom:2px solid rgba(214,233,240,.6);padding-bottom:6px
    }
    .agenda-event{
      background:rgba(154,205,223,.25);color:#3a5a6b;padding:14px;border-radius:8px;margin-bottom:10px;border-left:4px solid #6b9fc7
    }

    .loading{text-align:center;padding:32px;font-size:16px;color:#5a7c89}
    .error-message{background:rgba(240,230,210,.9);color:#8b5a3c;padding:16px;border-radius:8px;margin:14px;border-left:4px solid #d4a574}
    .setup-instructions{background:rgba(214,233,240,.9);color:#3a5a6b;padding:16px;border-radius:8px;margin:14px;border-left:4px solid #6b9fc7}
    .setup-instructions code{background:rgba(107,159,199,.18);padding:2px 6px;border-radius:4px;font-family:'Courier New',monospace}

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    .tooltip{position:absolute;background:rgba(44,62,80,.95);color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;z-index:1000;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .2s}
    .tooltip.show{opacity:1}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .event-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;justify-content:center;align-items:center;z-index:2000}
    .event-modal.show{display:flex}
    .event-modal-content{
      background:linear-gradient(135deg,#e8f4f8 0%,#f0f8e8 100%);border-radius:18px;padding:24px;max-width:520px;width:90%;
      max-height:80vh;overflow-y:auto;position:relative;border:1px solid rgba(255,255,255,.35);box-shadow:0 20px 40px rgba(0,0,0,.25)
    }
    .event-modal-close{
      position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;color:#5a7c89;cursor:pointer;width:32px;height:32px;border-radius:50%
    }
    .event-modal-title{font-size:22px;font-weight:800;color:#2c3e50;margin-bottom:16px}
    .event-detail-item{display:flex;gap:10px;padding:10px;background:rgba(255,255,255,.45);border-radius:10px;margin-bottom:10px}
    .event-detail-icon{font-size:18px;min-width:20px}
    .event-detail-label{font-weight:700;color:#2c3e50;font-size:14px;margin-bottom:4px}
    .event-detail-value{color:#34495e;font-size:14px;line-height:1.5;word-break:break-word}
    .event-detail-value a{color:#3498db;text-decoration:underline;word-break:break-all}

    @media (max-width:768px){
      .calendar-cell{min-height:100px}
      .month-year{font-size:20px}
    }
    @media (max-width:480px){
      body{padding:10px}
      .calendar-cell{min-height:90px;padding:6px 5px}
      .event{font-size:10px;padding:3px 6px}
      .event-time{font-size:9px}
      .event-title{font-size:10px}
      .week-day-column::before,.week-grid::after{background:rgba(180,205,220,.95)}
    }
  </style>
</head>
<body>
  <div class="calendar-container">
    <div class="calendar-header">
      <div class="navs">
        <button class="nav-button" id="prevBtn" aria-label="å‰ã®æœˆ">â€¹</button>
        <button class="nav-button" id="nextBtn" aria-label="æ¬¡ã®æœˆ">â€º</button>
        <button class="nav-button" id="todayBtn" aria-label="ä»Šæ—¥ã¸">ä»Šæ—¥</button>
      </div>
      <div class="month-year" id="monthYear"></div>
      <div class="view-controls">
        <button class="view-button active" onclick="switchView('month', this)">æœˆ</button>
        <button class="view-button" onclick="switchView('week', this)">é€±</button>
        <button class="view-button" onclick="switchView('agenda', this)">äºˆå®š</button>
      </div>
    </div>

    <div id="loading" class="loading">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="error" class="error-message" style="display:none;"></div>

    <div id="setupInstructions" class="setup-instructions" style="display:none;">
      <h3>ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †</h3>
      <ol>
        <li><strong>APIã‚­ãƒ¼ã‚’å–å¾—:</strong> Google Cloud Console ã§ Google Calendar API ã‚’æœ‰åŠ¹åŒ–ã— APIã‚­ãƒ¼ã‚’ä½œæˆ</li>
        <li><strong>APIã‚­ãƒ¼åˆ¶é™:</strong> HTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã«ä»¥ä¸‹ã‚’è¿½åŠ :
          <br><code>https://ame-chapchap.github.io/*</code>
          <br><code>http://localhost:*</code>ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        </li>
        <li><strong>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¬é–‹:</strong> å¯¾è±¡ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã€Œä¸€èˆ¬å…¬é–‹ã€ã«è¨­å®š</li>
        <li><strong>ã‚³ãƒ¼ãƒ‰æ›´æ–°:</strong> ä¸‹ã® <code>apiKey</code> ã¨ <code>calendarId</code> ã‚’è¨­å®š</li>
      </ol>
    </div>

    <!-- æœˆ -->
    <div id="monthView" class="calendar-view active">
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- é€± -->
    <div id="weekView" class="week-view">
      <div class="week-header">
        <div class="time-column">æ™‚é–“</div>
        <div class="day-header" id="weekDay0">æœˆ</div>
        <div class="day-header" id="weekDay1">ç«</div>
        <div class="day-header" id="weekDay2">æ°´</div>
        <div class="day-header" id="weekDay3">æœ¨</div>
        <div class="day-header" id="weekDay4">é‡‘</div>
        <div class="day-header" id="weekDay5">åœŸ</div>
        <div class="day-header" id="weekDay6">æ—¥</div>
      </div>
      <div class="week-grid">
        <div class="week-time-column">
          <div class="week-time-slot">6:00</div><div class="week-time-slot">7:00</div>
          <div class="week-time-slot">8:00</div><div class="week-time-slot">9:00</div>
          <div class="week-time-slot">10:00</div><div class="week-time-slot">11:00</div>
          <div class="week-time-slot">12:00</div><div class="week-time-slot">13:00</div>
          <div class="week-time-slot">14:00</div><div class="week-time-slot">15:00</div>
          <div class="week-time-slot">16:00</div><div class="week-time-slot">17:00</div>
          <div class="week-time-slot">18:00</div><div class="week-time-slot">19:00</div>
          <div class="week-time-slot">20:00</div><div class="week-time-slot">21:00</div>
          <div class="week-time-slot">22:00</div><div class="week-time-slot">23:00</div>
        </div>
        <div class="week-day-column" id="weekColumn0"></div>
        <div class="week-day-column" id="weekColumn1"></div>
        <div class="week-day-column" id="weekColumn2"></div>
        <div class="week-day-column" id="weekColumn3"></div>
        <div class="week-day-column" id="weekColumn4"></div>
        <div class="week-day-column" id="weekColumn5"></div>
        <div class="week-day-column" id="weekColumn6"></div>
      </div>
    </div>

    <!-- äºˆå®š -->
    <div id="agendaView" class="agenda-view">
      <div id="agendaContainer"></div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="eventModal" class="event-modal" aria-modal="true" role="dialog">
    <div class="event-modal-content">
      <button class="event-modal-close" onclick="closeEventModal()" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      <div class="event-modal-title" id="modalTitle">ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«</div>
      <div class="event-modal-details" id="modalDetails"></div>
    </div>
  </div>

  <script>
    /* ====== è¨­å®š ====== */
    let apiKey   = 'YOUR_API_KEY_HERE'; // â† å¿…è¦ã«å¿œã˜ã¦ç½®ãæ›ãˆ
    const calendarId = 'isalang.2ain@gmail.com'; // å…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID

    /* ====== çŠ¶æ…‹ ====== */
    let currentDate = new Date();     // è¡¨ç¤ºä¸­ã®åŸºæº–æ—¥
    let currentView = 'month';        // 'month' | 'week' | 'agenda'
    let events = [];                  // å–å¾—æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆä¿æŒ

    const monthNames = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    const dayNames   = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('prevBtn').addEventListener('click', previousMonth);
      document.getElementById('nextBtn').addEventListener('click', nextMonth);
      document.getElementById('todayBtn').addEventListener('click', goToToday);
      loadCalendar();
    });

    function validateApiKey(){
      if (!apiKey || apiKey === 'YOUR_API_KEY_HERE' || apiKey.length < 20){
        showError('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ­£ã—ã„APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return false;
      }
      return true;
    }

    async function loadCalendar(){
      showLoading(true); hideError();

      const startDate = getCalendarStartDate(currentDate);
      const endDate   = getCalendarEndDate(currentDate);

      events = await fetchEvents(startDate, endDate);

      showLoading(false);
      updateDisplay();
    }

    /* ====== æœŸé–“è¨ˆç®— ====== */
    function getCalendarStartDate(date){
      const first = new Date(date.getFullYear(), date.getMonth(), 1);
      const day = first.getDay(); // 0=æ—¥
      const mondayOffset = day === 0 ? 6 : day - 1;
      const start = new Date(first);
      start.setDate(first.getDate() - mondayOffset);
      return start;
    }
    function getCalendarEndDate(date){
      const last = new Date(date.getFullYear(), date.getMonth()+1, 0);
      const day = last.getDay();
      const sundayOffset = day === 0 ? 0 : 7 - day;
      const end = new Date(last);
      end.setDate(last.getDate() + sundayOffset);
      return end;
    }

    /* ====== API ====== */
    async function fetchEvents(startDate, endDate){
      if (!validateApiKey()) return [];
      const params = new URLSearchParams({
        key: apiKey,
        timeMin: startDate.toISOString(),
        timeMax: endDate.toISOString(),
        singleEvents: 'true',
        orderBy: 'startTime'
      });
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?${params.toString()}`;
      try{
        const res = await fetch(url);
        if (!res.ok){
          let msg = `API ã‚¨ãƒ©ãƒ¼: ${res.status} ${res.statusText}`;
          if (res.status === 403) msg = 'APIã‚­ãƒ¼ã¾ãŸã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å…¬é–‹è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼ˆ403ï¼‰ã€‚';
          if (res.status === 404) msg = 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ404ï¼‰ã€‚';
          throw new Error(msg);
        }
        const data = await res.json();
        return data.items || [];
      }catch(e){
        showError('âŒ ' + e.message);
        return [];
      }
    }

    /* ====== è¡¨ç¤ºæ›´æ–° ====== */
    function updateDisplay(){
      updateMonthYear();
      if (currentView === 'month') generateMonthView();
      else if (currentView === 'week') generateWeekView();
      else if (currentView === 'agenda') generateAgendaView();
    }
    function updateMonthYear(){
      const el = document.getElementById('monthYear');
      el.textContent = `${currentDate.getFullYear()}å¹´ ${monthNames[currentDate.getMonth()]}`;
    }

    /* ====== æœˆãƒ“ãƒ¥ãƒ¼ ====== */
    function generateMonthView(){
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      for (const d of dayNames){
        const th = document.createElement('div');
        th.className = 'calendar-header-cell';
        th.textContent = d;
        grid.appendChild(th);
      }

      const start = getCalendarStartDate(currentDate);
      const today = new Date();

      for (let i=0;i<42;i++){
        const cellDate = new Date(start); cellDate.setDate(start.getDate()+i);

        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        if (cellDate.getMonth() !== currentDate.getMonth()) cell.classList.add('other-month');
        if (isSameDay(cellDate, today)) cell.classList.add('today');

        const num = document.createElement('div');
        num.className = 'date-number';
        num.textContent = cellDate.getDate();
        cell.appendChild(num);

        const dayEvents = getEventsForDate(cellDate);
        for (const ev of dayEvents){
          const el = createEventElement(ev, 'month');
          cell.appendChild(el);
        }
        grid.appendChild(cell);
      }
    }

    /* ====== é€±ãƒ“ãƒ¥ãƒ¼ ====== */
    function generateWeekView(){
      const startOfWeek = getStartOfWeek(currentDate);
      const today = new Date();

      for (let i=0;i<7;i++){
        const day = new Date(startOfWeek); day.setDate(startOfWeek.getDate()+i);
        const header = document.getElementById(`weekDay${i}`);
        const col = document.getElementById(`weekColumn${i}`);
        header.textContent = `${dayNames[i]} ${day.getDate()}`;
        col.classList.toggle('today', isSameDay(day, today));
        col.innerHTML = '';

        // ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ6-23ï¼‰
        for (let h=6; h<24; h++){
          const slot = document.createElement('div');
          slot.className = 'week-time-slot-day';
          col.appendChild(slot);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆé…ç½®ï¼ˆæ™‚é–“å¸¯å…ˆé ­ã«å·®ã—è¾¼ã‚€ç°¡æ˜“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
        const dayEvents = getEventsForDate(day);
        for (const ev of dayEvents){
          const el = createWeekEventElement(ev);
          if (!el) continue;
          const startTime = new Date(ev.start.dateTime || ev.start.date);
          if (ev.start.dateTime){
            const hour = startTime.getHours();
            if (hour >= 6 && hour < 24){
              const idx = hour - 6;
              col.children[idx]?.appendChild(el);
            }else{
              col.children[0]?.appendChild(el); // ç¯„å›²å¤–ã¯å…ˆé ­ã¸
            }
          }else{
            col.children[0]?.appendChild(el); // çµ‚æ—¥ã¯å…ˆé ­ã¸
          }
        }
      }
    }

    function createWeekEventElement(event){
      const wrap = document.createElement('div');
      wrap.className = 'week-event';
      const s = new Date(event.start.dateTime || event.start.date);
      const time = document.createElement('span');
      time.className = 'week-event-time';
      time.textContent = event.start.dateTime ? formatTime(s) : 'çµ‚æ—¥';

      const title = document.createElement('span');
      title.className = 'week-event-title';
      let t = (event.summary || 'ç„¡é¡Œ').split('\n')[0];
      title.textContent = t.length>15 ? t.slice(0,15)+'â€¦' : t;

      wrap.appendChild(time); wrap.appendChild(document.createElement('br')); wrap.appendChild(title);
      wrap.addEventListener('click', (e)=>{ e.stopPropagation(); showEventModal(event); });

      if (isPastEvent(event)) wrap.classList.add('past'); // åŒã˜ã‚¯ãƒ©ã‚¹ã§æ·¡è‰²ã‚‚å¯
      return wrap;
    }

    /* ====== äºˆå®šãƒ“ãƒ¥ãƒ¼ï¼ˆè¦ä»¶3ï¼šéå»éè¡¨ç¤ºï¼‹ç›´è¿‘é †ï¼‰ ====== */
    function generateAgendaView(){
      const container = document.getElementById('agendaContainer');
      container.innerHTML = '';

      const now = new Date();
      // å®Œå…¨çµ‚äº†ã—ã¦ã„ãªã„ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿
      const upcoming = events.filter(ev => !isPastEvent(ev, now));

      // è¿‘ã„é †ï¼ˆé–‹å§‹ï¼‰ã«ã‚½ãƒ¼ãƒˆ
      upcoming.sort((a,b)=>{
        const as = new Date(a.start.dateTime || a.start.date);
        const bs = new Date(b.start.dateTime || b.start.date);
        return as - bs;
      });

      // æ—¥ä»˜ã‚°ãƒ«ãƒ¼ãƒ—
      const byDate = {};
      for (const ev of upcoming){
        const d = new Date(ev.start.dateTime || ev.start.date);
        const key = d.toISOString().slice(0,10);
        (byDate[key] ||= []).push(ev);
      }

      const keys = Object.keys(byDate).sort();
      for (const key of keys){
        const d = new Date(key);
        const dow = d.getDay();
        const jpDow = dayNames[dow===0?6:dow-1];
        const header = document.createElement('div');
        header.className = 'agenda-date';
        header.textContent = `${d.getDate()}æ—¥ (${jpDow})`;
        container.appendChild(header);

        for (const ev of byDate[key]){
          const el = createEventElement(ev, 'agenda');
          el.className = 'agenda-event';
          container.appendChild(el);
        }
      }

      if (upcoming.length===0){
        const empty = document.createElement('div');
        empty.className = 'agenda-event';
        empty.textContent = 'ä»Šå¾Œã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        container.appendChild(empty);
      }
    }

    /* ====== å…±é€šï¼šã‚¤ãƒ™ãƒ³ãƒˆè¦ç´  ====== */
    function createEventElement(event, viewType){
      const div = document.createElement('div');
      div.className = 'event';

      const s = new Date(event.start.dateTime || event.start.date);
      const e = new Date(event.end.dateTime || event.end.date);

      const time = document.createElement('span');
      time.className = 'event-time';
      time.textContent = event.start.dateTime ? formatTime(s) : '';

      const title = document.createElement('span');
      title.className = 'event-title';
      let t = (event.summary || 'ç„¡é¡Œ').split('\n')[0];
      const maxLen = viewType==='month' ? (window.innerWidth<=480 ? 8 : 12) : 50;
      title.textContent = t.length>maxLen ? t.slice(0,maxLen)+'â€¦' : t;

      div.appendChild(time); div.appendChild(title);

      // è©³ç´°ãƒ»ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
      div.addEventListener('click', (ev)=>{ ev.stopPropagation(); showEventModal(event); });
      if (t.length>maxLen){
        div.setAttribute('data-full-title', event.summary || 'ç„¡é¡Œ');
        div.addEventListener('mouseenter', showTooltip);
        div.addEventListener('mouseleave', hideTooltip);
        div.addEventListener('mousemove', moveTooltip);
      }

      // éå»åˆ¤å®šï¼ˆè¦ä»¶1ï¼šæœˆãƒ“ãƒ¥ãƒ¼ã§ã®æ·¡è‰²ã€‚äºˆå®šãƒ“ãƒ¥ãƒ¼ã¯ãã‚‚ãã‚‚å‡ºã•ãªã„ï¼‰
      if (isPastEvent(event)) div.classList.add('past');

      return div;
    }

    function getEventsForDate(date){
      return events.filter(ev=>{
        const start = new Date(ev.start.dateTime || ev.start.date);
        return isSameDay(start, date);
      });
    }

    function getStartOfWeek(date){
      const d = new Date(date);
      const w = d.getDay(); // 0æ—¥
      const diff = w===0 ? 6 : w-1;
      d.setDate(d.getDate()-diff);
      return d;
    }

    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function formatTime(d){
      const h = String(d.getHours()).padStart(2,'0');
      const m = String(d.getMinutes()).padStart(2,'0');
      return `${h}:${m}`;
    }

    /* ====== éå»åˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆçµ‚æ—¥ã® end è£œæ­£è¾¼ã¿ï¼‰ ====== */
    function getEffectiveEnd(ev){
      if (ev?.end?.dateTime) return new Date(ev.end.dateTime);
      if (ev?.end?.date) return new Date(new Date(ev.end.date).getTime()-1); // çµ‚æ—¥ã¯ç¿Œæ—¥0:00 â†’ å½“æ—¥æœ«ã¸
      return new Date(0);
    }
    function isPastEvent(ev, now = new Date()){
      return getEffectiveEnd(ev) < now;
    }

    /* ====== ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ & ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ ====== */
    function previousMonth(){ currentDate.setMonth(currentDate.getMonth()-1); loadCalendar(); }
    function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); loadCalendar(); }
    function goToToday(){ currentDate = new Date(); loadCalendar(); }

    function switchView(view, el){
      currentView = view;
      document.querySelectorAll('.view-button').forEach(b=>b.classList.remove('active'));
      if (el) el.classList.add('active');

      document.querySelectorAll('.calendar-view,.week-view,.agenda-view').forEach(v=>v.classList.remove('active'));
      if (view==='month') document.getElementById('monthView').classList.add('active');
      if (view==='week') document.getElementById('weekView').classList.add('active');
      if (view==='agenda') document.getElementById('agendaView').classList.add('active');

      updateDisplay();
    }

    /* ====== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ ====== */
    function showLoading(b){ document.getElementById('loading').style.display = b ? 'block' : 'none'; }
    function showError(msg){
      const e = document.getElementById('error');
      e.textContent = msg; e.style.display = 'block';
      if (msg.includes('APIã‚­ãƒ¼') || msg.includes('å…¬é–‹') || msg.includes('API ã‚¨ãƒ©ãƒ¼')) {
        document.getElementById('setupInstructions').style.display = 'block';
      }
    }
    function hideError(){
      document.getElementById('error').style.display = 'none';
      document.getElementById('setupInstructions').style.display = 'none';
    }

    /* ====== ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— ====== */
    function showTooltip(ev){
      const tip = document.getElementById('tooltip');
      tip.textContent = ev.currentTarget.getAttribute('data-full-title');
      tip.classList.add('show');
    }
    function hideTooltip(){ document.getElementById('tooltip').classList.remove('show'); }
    function moveTooltip(ev){
      const tip = document.getElementById('tooltip');
      tip.style.left = (ev.pageX + 10) + 'px';
      tip.style.top  = (ev.pageY - 28) + 'px';
    }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
    function showEventModal(event){
      const modal = document.getElementById('eventModal');
      const title = document.getElementById('modalTitle');
      const details = document.getElementById('modalDetails');
      title.textContent = event.summary || 'ç„¡é¡Œã®ã‚¤ãƒ™ãƒ³ãƒˆ';
      details.innerHTML = '';

      const s = new Date(event.start.dateTime || event.start.date);
      const e = new Date(event.end.dateTime || event.end.date);

      let dt = '';
      if (event.start.dateTime && event.end.dateTime){
        if (isSameDay(s,e)) dt = `${formatDate(s)} ${formatTime(s)} - ${formatTime(e)}`;
        else dt = `${formatDate(s)} ${formatTime(s)} - ${formatDate(e)} ${formatTime(e)}`;
      }else{
        // çµ‚æ—¥
        if (isSameDay(s,e) || (e - s === 24*60*60*1000)) dt = `${formatDate(s)} (çµ‚æ—¥)`;
        else{
          const adjEnd = new Date(e.getTime()-24*60*60*1000);
          dt = `${formatDate(s)} - ${formatDate(adjEnd)} (çµ‚æ—¥)`;
        }
      }
      addDetailItem('ğŸ•’','æ—¥æ™‚',dt);

      if (event.description) addDetailItem('ğŸ“','èª¬æ˜',convertUrlsToLinks(event.description),true);
      if (event.location)    addDetailItem('ğŸ“','å ´æ‰€',convertUrlsToLinks(event.location),true);

      if (event.conferenceData?.entryPoints){
        const video = event.conferenceData.entryPoints
          .filter(x=>x.entryPointType==='video')
          .map(x=>`<a href="${x.uri}" target="_blank" rel="noopener noreferrer">${x.uri}</a>`).join('<br>');
        if (video) addDetailItem('ğŸ¥','ä¼šè­°ãƒªãƒ³ã‚¯',video,true);
      }
      if (event.htmlLink) addDetailItem('ğŸ”—','Google Calendar',`<a href="${event.htmlLink}" target="_blank">${event.htmlLink}</a>`,true);
      if (event.creator?.displayName) addDetailItem('ğŸ‘¤','ä½œæˆè€…',event.creator.displayName);

      modal.classList.add('show'); document.body.style.overflow='hidden';
    }
    function closeEventModal(){
      document.getElementById('eventModal').classList.remove('show');
      document.body.style.overflow='';
    }
    function addDetailItem(icon,label,value,isHtml=false){
      const details = document.getElementById('modalDetails');
      const item = document.createElement('div'); item.className='event-detail-item';
      const iconDiv = document.createElement('div'); iconDiv.className='event-detail-icon'; iconDiv.textContent=icon;
      const content = document.createElement('div'); content.className='event-detail-content';
      const l = document.createElement('div'); l.className='event-detail-label'; l.textContent=label;
      const v = document.createElement('div'); v.className='event-detail-value';
      if (isHtml) v.innerHTML=value; else v.textContent=value;
      content.appendChild(l); content.appendChild(v); item.appendChild(iconDiv); item.appendChild(content);
      details.appendChild(item);
    }
    function formatDate(d){
      const y=d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
      const dow=d.getDay(); const jpDow = dayNames[dow===0?6:dow-1];
      return `${y}å¹´${m}æœˆ${day}æ—¥ (${jpDow})`;
    }
    function convertUrlsToLinks(text){
      let html = (text||'').replace(/\n/g,'<br>');
      const re = /(https?:\/\/[^\s<>"\[\]{}|\\^`]+)/gi;
      return html.replace(re, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ãƒ»Esc
    document.addEventListener('click', (ev)=>{ if (ev.target.id==='eventModal') closeEventModal(); });
    document.addEventListener('keydown', (ev)=>{ if (ev.key==='Escape') closeEventModal(); });
  </script>
</body>
</html>
